name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-python-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build Wheel + Sdist
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Upload Python Packages
        uses: actions/upload-artifact@v4
        with:
          name: python-packages
          path: dist/*

  build-standalone:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-13
            platform_tag: macos-x64
          - os: macos-14
            platform_tag: macos-arm64
          - os: windows-latest
            platform_tag: windows-x64
          - os: ubuntu-latest
            platform_tag: linux-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e .[release]

      - name: Build Standalone Artifact
        run: |
          python scripts/release/build_standalone.py --platform-tag "${{ matrix.platform_tag }}" --release-version "${{ github.ref_name }}"

      - name: macOS Notarization Placeholder
        if: startsWith(matrix.platform_tag, 'macos')
        env:
          APPLE_ID: ${{ secrets.MACOS_NOTARIZE_APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.MACOS_NOTARIZE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.MACOS_NOTARIZE_APP_PASSWORD }}
        run: |
          if [ -n "$APPLE_ID" ] && [ -n "$APPLE_TEAM_ID" ] && [ -n "$APPLE_APP_PASSWORD" ]; then
            echo "macOS signing/notarization secrets detected."
            echo "ok" > "dist/release/signing-${{ matrix.platform_tag }}.ok"
          else
            echo "macOS signing secrets missing."
            echo "missing" > "dist/release/signing-${{ matrix.platform_tag }}.missing"
          fi

      - name: Windows Signing Placeholder
        if: matrix.platform_tag == 'windows-x64'
        shell: pwsh
        env:
          WINDOWS_SIGN_CERT: ${{ secrets.WINDOWS_SIGN_CERT }}
          WINDOWS_SIGN_PASSWORD: ${{ secrets.WINDOWS_SIGN_PASSWORD }}
        run: |
          if ($env:WINDOWS_SIGN_CERT -and $env:WINDOWS_SIGN_PASSWORD) {
            Write-Output "Windows signing secrets detected."
            Set-Content -Path "dist/release/signing-${{ matrix.platform_tag }}.ok" -Value "ok"
          } else {
            Write-Output "Windows signing secrets missing."
            Set-Content -Path "dist/release/signing-${{ matrix.platform_tag }}.missing" -Value "missing"
          }

      - name: Upload Standalone Artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform_tag }}
          path: dist/release/*

  prepare-manifests:
    runs-on: ubuntu-latest
    needs: build-standalone
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Download Standalone Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: dist/release

      - name: Verify Artifact Checksums
        run: |
          set -euo pipefail
          cd dist/release
          for checksum_file in *.sha256; do
            sha256sum -c "${checksum_file}"
          done

      - name: Enforce Signing Gate
        env:
          ALLOW_UNSIGNED_RELEASE: ${{ secrets.ALLOW_UNSIGNED_RELEASE }}
        run: |
          set -euo pipefail
          shopt -s nullglob
          missing=(dist/release/signing-*.missing)
          if [ "${#missing[@]}" -eq 0 ]; then
            echo "Signing gate passed."
            exit 0
          fi
          if [ "${ALLOW_UNSIGNED_RELEASE:-}" = "1" ]; then
            echo "Unsigned release override enabled."
            printf 'Missing signing markers:\n'
            printf '%s\n' "${missing[@]}"
            exit 0
          fi
          echo "Signing gate failed. Missing signing secrets/artifacts:"
          printf '%s\n' "${missing[@]}"
          exit 1

      - name: Compute Checksums
        id: checksums
        run: |
          arm_sha="$(cut -d ' ' -f1 dist/release/hackluminary-macos-arm64.tar.gz.sha256)"
          x64_sha="$(cut -d ' ' -f1 dist/release/hackluminary-macos-x64.tar.gz.sha256)"
          win_sha="$(cut -d ' ' -f1 dist/release/hackluminary-windows-x64.zip.sha256)"
          echo "arm_sha=${arm_sha}" >> "${GITHUB_OUTPUT}"
          echo "x64_sha=${x64_sha}" >> "${GITHUB_OUTPUT}"
          echo "win_sha=${win_sha}" >> "${GITHUB_OUTPUT}"

      - name: Render Homebrew Formula
        run: |
          python scripts/release/render_homebrew_formula.py \
            --version "${{ github.ref_name }}" \
            --repo "${{ github.repository }}" \
            --arm64-sha256 "${{ steps.checksums.outputs.arm_sha }}" \
            --x64-sha256 "${{ steps.checksums.outputs.x64_sha }}" \
            --output dist/manifests/homebrew/hackluminary.rb

      - name: Render Winget Manifest
        run: |
          python scripts/release/render_winget_manifest.py \
            --version "${{ github.ref_name }}" \
            --repo "${{ github.repository }}" \
            --installer-sha256 "${{ steps.checksums.outputs.win_sha }}" \
            --output-dir dist/manifests/winget

      - name: Upload Manifests
        uses: actions/upload-artifact@v4
        with:
          name: release-manifests
          path: dist/manifests/*

  publish-release:
    runs-on: ubuntu-latest
    needs: [build-python-package, build-standalone, prepare-manifests]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: List Artifacts
        run: ls -R release-assets

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/**/*
          generate_release_notes: true
